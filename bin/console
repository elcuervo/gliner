#!/usr/bin/env ruby
# frozen_string_literal: true

begin
  require "bundler/setup"
rescue LoadError
end

require "gliner"
require "fileutils"
require "httpx"
require "irb"

DEFAULT_REPO_ID = "cuerbot/gliner2-multi-v1"
DEFAULT_MODEL_FILE = "model_fp16.onnx"
DEFAULT_MODEL_SUBDIR = "onnx"

def ensure_model_dir!(repo_id:, model_file:, model_subdir:)
  dir = File.expand_path("../tmp/models/#{repo_id.tr('/', '__')}", __dir__)
  FileUtils.mkdir_p(dir)

  base = "https://huggingface.co/#{repo_id}/resolve/main"
  base = "#{base}/#{model_subdir}" unless model_subdir.nil? || model_subdir.empty?
  files = ["tokenizer.json", "config.json", model_file]

  files.each do |file|
    dest = File.join(dir, file)
    next if File.exist?(dest) && File.size?(dest)
    download("#{base}/#{file}", dest)
  end

  dir
end

def download(url, dest)
  response = HTTPX.get(url)
  raise "Download failed: #{url} (status: #{response.status})" unless response.status.between?(200, 299)

  File.binwrite(dest, response.body.to_s)
end

model_dir = ARGV[0] || ENV["GLINER_MODEL_DIR"]
repo_id = ENV["GLINER_REPO_ID"] || DEFAULT_REPO_ID
model_file = ENV["GLINER_MODEL_FILE"] || DEFAULT_MODEL_FILE
model_subdir = ENV["GLINER_MODEL_SUBDIR"] || DEFAULT_MODEL_SUBDIR

if model_dir && !model_dir.empty?
  $gliner_model = Gliner.load(model_dir, file: model_file)
else
  begin
    require "fileutils"
    model_dir = ensure_model_dir!(repo_id: repo_id, model_file: model_file, model_subdir: model_subdir)
    $gliner_model = Gliner.load(model_dir, file: model_file)
  rescue => e
    warn "No model loaded (auto-download failed: #{e.class}: #{e.message})"
    warn "Set GLINER_MODEL_DIR to a local model dir, or set GLINER_REPO_ID/GLINER_MODEL_FILE for auto-download."
  end
end

def gliner_extract(text, labels, **opts)
  raise "No model loaded (set GLINER_MODEL_DIR or pass a directory arg)" unless $gliner_model
  Gliner[labels][text, **opts]
end

def gliner_classify(text, tasks, **opts)
  raise "No model loaded (set GLINER_MODEL_DIR or pass a directory arg)" unless $gliner_model
  Gliner.classify[tasks][text, **opts]
end

def gliner_extract_json(text, structures, **opts)
  raise "No model loaded (set GLINER_MODEL_DIR or pass a directory arg)" unless $gliner_model
  Gliner[structures][text, **opts]
end

puts "Gliner console"
puts "- model: #{$gliner_model ? "loaded" : "not loaded"}"
puts "- helper: gliner_extract(text, labels, threshold: 0.5)"
puts "- helper: gliner_classify(text, tasks)"
puts "- helper: gliner_extract_json(text, structures)"
puts "- model variable: $gliner_model"
puts "- model dir: #{model_dir.inspect}"
puts "- auto-download env: GLINER_REPO_ID=#{repo_id.inspect} GLINER_MODEL_FILE=#{model_file.inspect}" unless $gliner_model

IRB.start(__FILE__)
