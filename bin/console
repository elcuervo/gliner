#!/usr/bin/env ruby

# frozen_string_literal: true

begin
  require "bundler/setup"
rescue LoadError
end

require "gliner"
require "irb"

model_dir = ARGV[0] || ENV["GLINER_MODEL_DIR"]
model_file = ENV["GLINER_MODEL_FILE"]

if model_dir && !model_dir.empty?
  $gliner_model = model_file ? Gliner.load(model_dir, file: model_file) : Gliner.load(model_dir)
else
  begin
    Gliner.configure { |config| config.auto = true }
    $gliner_model = Gliner.model
  rescue => e
    warn "No model loaded (auto-download failed: #{e.class}: #{e.message})"
    warn "Set GLINER_MODEL_DIR or configure Gliner.config.model to a local model dir."
  end
end

def gliner_extract(text, labels, **opts)
  raise "No model loaded (set GLINER_MODEL_DIR or pass a directory arg)" unless $gliner_model
  Gliner[labels][text, **opts]
end

def gliner_classify(text, tasks, **opts)
  raise "No model loaded (set GLINER_MODEL_DIR or pass a directory arg)" unless $gliner_model
  Gliner.classify[tasks][text, **opts]
end

def gliner_extract_json(text, structures, **opts)
  raise "No model loaded (set GLINER_MODEL_DIR or pass a directory arg)" unless $gliner_model
  Gliner[structures][text, **opts]
end

puts "Gliner console"
puts "- model: #{$gliner_model ? "loaded" : "not loaded"}"
puts "- helper: gliner_extract(text, labels, threshold: 0.5)"
puts "- helper: gliner_classify(text, tasks)"
puts "- helper: gliner_extract_json(text, structures)"
puts "- model variable: $gliner_model"
puts "- model dir: #{model_dir.inspect}"

IRB.start(__FILE__)
